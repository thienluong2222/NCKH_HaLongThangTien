<div class="heritage-chat" [class.has-results]="festivalService.hasResults()">
  <!-- Header Section -->
  <div class="chat-header">
    <div class="header-decoration">
      <span class="lantern left">üèÆ</span>
      <span class="lantern right">üèÆ</span>
    </div>
    <div class="header-content">
      <div class="header-icon">
        <span class="icon-inner">üéé</span>
        <div class="icon-ring"></div>
      </div>
      <div class="header-text">
        <h3>Tr·ª£ l√Ω Di s·∫£n AI</h3>
        <p>{{ workflowStep() === 'upload' ? 'T·∫£i l√™n h√¨nh ·∫£nh ho·∫∑c video ƒë·ªÉ b·∫Øt ƒë·∫ßu' : 
             workflowStep() === 'analyzing' ? 'ƒêang ph√¢n t√≠ch...' :
             workflowStep() === 'questioning' ? 'Tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c' :
             'Ph√¢n t√≠ch ho√†n t·∫•t!' }}</p>
      </div>
      @if (workflowStep() !== 'upload') {
        <button mat-icon-button class="reset-btn" (click)="resetWorkflow()" matTooltip="B·∫Øt ƒë·∫ßu l·∫°i">
          <mat-icon>refresh</mat-icon>
        </button>
      }
    </div>
    <!-- Workflow Progress -->
    <div class="workflow-progress">
      <div class="progress-step" [class.active]="workflowStep() === 'upload'" [class.completed]="workflowStep() !== 'upload'">
        <span class="step-icon">üì§</span>
        <span class="step-label">T·∫£i l√™n</span>
      </div>
      <div class="progress-line" [class.active]="workflowStep() !== 'upload'"></div>
      <div class="progress-step" [class.active]="workflowStep() === 'analyzing'" [class.completed]="workflowStep() === 'questioning' || workflowStep() === 'completed'">
        <span class="step-icon">üîç</span>
        <span class="step-label">Ph√¢n t√≠ch</span>
      </div>
      <div class="progress-line" [class.active]="workflowStep() === 'questioning' || workflowStep() === 'completed'"></div>
      <div class="progress-step" [class.active]="workflowStep() === 'questioning'" [class.completed]="workflowStep() === 'completed'">
        <span class="step-icon">üí¨</span>
        <span class="step-label">H·ªèi ƒë√°p</span>
      </div>
      <div class="progress-line" [class.active]="workflowStep() === 'completed'"></div>
      <div class="progress-step" [class.active]="workflowStep() === 'completed'">
        <span class="step-icon">‚úÖ</span>
        <span class="step-label">Ho√†n t·∫•t</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="chat-body">
    <!-- Upload Zone (Step 1) -->
    @if (workflowStep() === 'upload') {
      <div class="upload-section">
        <!-- Drop Zone -->
        <div 
          class="drop-zone"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          
          @if (!hasUploads()) {
            <div class="drop-content">
              <div class="drop-icon">
                <span class="main-icon">üìÅ</span>
                <div class="icon-ring"></div>
              </div>
              <h4>K√©o th·∫£ t·ªáp v√†o ƒë√¢y</h4>
              <p>ho·∫∑c ch·ªçn t·ª´ thi·∫øt b·ªã c·ªßa b·∫°n</p>
              
              <div class="upload-buttons">
                <button mat-stroked-button class="upload-btn image" (click)="triggerImageUpload()">
                  <mat-icon>photo_library</mat-icon>
                  <span>H√¨nh ·∫£nh</span>
                </button>
                <button mat-stroked-button class="upload-btn video" (click)="triggerVideoUpload()">
                  <mat-icon>videocam</mat-icon>
                  <span>Video</span>
                </button>
              </div>
              
              <p class="supported-formats">H·ªó tr·ª£: JPG, PNG, GIF, MP4, MOV, AVI</p>
            </div>
          } @else {
            <!-- Preview Grid -->
            <div class="preview-section">
              <div class="preview-header">
                <span class="preview-count">{{ previews().length }} t·ªáp ƒë√£ ch·ªçn</span>
                <button mat-button class="add-more-btn" (click)="triggerImageUpload()">
                  <mat-icon>add</mat-icon> Th√™m
                </button>
              </div>
              
              <div class="preview-grid">
                @for (preview of previews(); track preview.url) {
                  <div class="preview-item" [class.video]="preview.type === 'video'">
                    @if (preview.type === 'image') {
                      <img [src]="preview.url" [alt]="preview.file.name">
                    } @else {
                      <video [src]="preview.url"></video>
                      <div class="video-overlay">
                        <mat-icon>play_circle</mat-icon>
                      </div>
                    }
                    <button class="remove-btn" (click)="removeFile(preview)">
                      <mat-icon>close</mat-icon>
                    </button>
                    <div class="file-info">
                      <span class="file-name">{{ preview.file.name }}</span>
                      <span class="file-size">{{ formatSize(preview.file.size) }}</span>
                    </div>
                  </div>
                }
              </div>
              
              <button 
                mat-flat-button 
                class="analyze-btn"
                [disabled]="!hasUploads()"
                (click)="startAnalysis()">
                <mat-icon>auto_awesome</mat-icon>
                <span>B·∫Øt ƒë·∫ßu ph√¢n t√≠ch</span>
                <div class="btn-shine"></div>
              </button>
            </div>
          }
        </div>
        
        <!-- Hidden file inputs -->
        <input 
          #imageInput
          type="file" 
          accept="image/*" 
          multiple 
          hidden
          (change)="onFileSelect($event, 'image')">
        <input 
          #videoInput
          type="file" 
          accept="video/*" 
          multiple 
          hidden
          (change)="onFileSelect($event, 'video')">
      </div>
    }

    <!-- Analyzing State -->
    @if (workflowStep() === 'analyzing') {
      <div class="analyzing-section">
        <div class="analyzing-animation">
          <div class="spinner">
            <div class="ring"></div>
            <span class="icon">üîç</span>
          </div>
          <h4>ƒêang ph√¢n t√≠ch di s·∫£n vƒÉn h√≥a...</h4>
          <p>AI ƒëang x·ª≠ l√Ω h√¨nh ·∫£nh v√† nh·∫≠n di·ªán c√°c y·∫øu t·ªë vƒÉn h√≥a</p>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </div>
        
        <!-- Small preview of uploaded files -->
        <div class="uploaded-preview">
          @for (preview of previews().slice(0, 3); track preview.url) {
            <div class="mini-preview">
              @if (preview.type === 'image') {
                <img [src]="preview.url" [alt]="preview.file.name">
              } @else {
                <video [src]="preview.url"></video>
              }
            </div>
          }
          @if (previews().length > 3) {
            <div class="more-count">+{{ previews().length - 3 }}</div>
          }
        </div>
      </div>
    }

    <!-- Chat Messages (Step 2 & 3) -->
    @if (workflowStep() === 'questioning' || workflowStep() === 'completed') {
      <div class="chat-messages" #messagesContainer>
        @for (message of chatService.messages(); track message.id) {
          <div 
            class="message" 
            [class.user]="message.role === 'user'"
            [class.ai]="message.role === 'ai'"
            [class.system]="message.role === 'system'">
            
            @if (message.role === 'ai' || message.role === 'system') {
              <div class="avatar ai-avatar">
                <span>üéé</span>
              </div>
            }
            
            <div class="message-bubble">
              <p [innerHTML]="message.content.replace('\n', '<br>')"></p>
              <span class="timestamp">{{ formatTime(message.timestamp) }}</span>
            </div>
            
            @if (message.role === 'user') {
              <div class="avatar user-avatar">
                <span>üë§</span>
              </div>
            }
          </div>
        }
        
        @if (isTyping()) {
          <div class="message ai">
            <div class="avatar ai-avatar">
              <span>üéé</span>
            </div>
            <div class="message-bubble typing">
              <div class="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
  
  <!-- Input Section (Only show after upload) -->
  @if (workflowStep() === 'questioning' || workflowStep() === 'completed') {
    <div class="chat-input-section">
      <!-- Uploaded files mini preview -->
      <div class="uploaded-files-bar">
        <div class="files-preview">
          @for (preview of previews().slice(0, 4); track preview.url) {
            <div class="mini-thumb">
              @if (preview.type === 'image') {
                <img [src]="preview.url" [alt]="preview.file.name">
              } @else {
                <video [src]="preview.url"></video>
              }
            </div>
          }
          @if (previews().length > 4) {
            <span class="more">+{{ previews().length - 4 }}</span>
          }
        </div>
        <span class="files-label">{{ previews().length }} t·ªáp ƒë√£ t·∫£i</span>
      </div>

      <div class="input-wrapper">
        <mat-form-field appearance="outline" class="input-field">
          <mat-label>Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n...</mat-label>
          <input 
            matInput 
            [value]="inputMessage()"
            (input)="inputMessage.set($any($event.target).value)"
            (keyup.enter)="sendMessage()"
            placeholder="VD: T√¥i th·∫•y c√≥ ƒë√®n hoa ƒëƒÉng tr√¥i tr√™n s√¥ng...">
          <mat-icon matSuffix class="input-icon">edit_note</mat-icon>
        </mat-form-field>
        
        <button 
          mat-fab 
          class="send-btn"
          [disabled]="!canSendMessage()"
          (click)="sendMessage()">
          <mat-icon>send</mat-icon>
        </button>
      </div>
      
      <!-- Quick Suggestions -->
      <div class="quick-suggestions">
        <span class="suggestion-label">
          <mat-icon>tips_and_updates</mat-icon>
          G·ª£i √Ω nhanh:
        </span>
        <div class="suggestion-chips">
          @for (suggestion of suggestions; track suggestion.text) {
            <button 
              mat-stroked-button 
              class="suggestion-chip"
              (click)="useSuggestion(suggestion)">
              <span class="chip-icon">{{ suggestion.icon }}</span>
              {{ suggestion.text }}
            </button>
          }
        </div>
      </div>
    </div>
  }
</div>
